package org.opentestsystem.rdw.multitenant.archive;

import org.opentestsystem.rdw.archive.ArchiveProperties;
import org.opentestsystem.rdw.archive.ArchivePropertiesImpl;
import org.opentestsystem.rdw.archive.ArchiveService;
import org.opentestsystem.rdw.archive.ArchiveServiceFacade;
import org.opentestsystem.rdw.multitenant.TenantIdResolver;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Configuration;

import java.util.concurrent.ConcurrentHashMap;

@Configuration
public class S3ArchiveServiceRouter {
    private final TenantIdResolver tenantIdResolver;
    private final ArchiveProperties archiveProperties;
    private final ConcurrentHashMap<Object, ArchivePropertiesTenant> resolvedArchivePropertiesTenant = new ConcurrentHashMap<>();

    @Autowired
    S3ArchiveServiceRouter(final TenantIdResolver tenantIdResolver, final ArchiveProperties archiveProperties) {
        this.tenantIdResolver = tenantIdResolver;
        this.archiveProperties = archiveProperties;
    }

    public ArchiveService getS3ArchiveService() {
        ArchivePropertiesResolver archivePropertiesResolver = new ArchivePropertiesResolver(tenantIdResolver, archiveProperties);
        ArchivePropertiesTenant archivePropertiesTenant = archivePropertiesResolver.getResolvedArchivePropertiesTenant().get();
        resolvedArchivePropertiesTenant.put(tenantIdResolver.getTenantId(),archivePropertiesTenant);
        ArchivePropertiesImpl archiveProperties = new ArchivePropertiesImpl(null, archivePropertiesTenant.getArchiveAwsProperties());
        return new ArchiveServiceFacade().createArchiveService(archiveProperties);
    }

    public ArchiveService getLocalArchiveService() {
        ArchivePropertiesResolver archivePropertiesResolver = new ArchivePropertiesResolver(tenantIdResolver, archiveProperties);
        ArchivePropertiesTenant archivePropertiesTenant = archivePropertiesResolver.getResolvedArchivePropertiesTenant().get();
        resolvedArchivePropertiesTenant.put(tenantIdResolver.getTenantId(),archivePropertiesTenant);
        ArchivePropertiesImpl archiveProperties = new ArchivePropertiesImpl(archivePropertiesTenant.getArchiveFileProperties(), null);
        return new ArchiveServiceFacade().createArchiveService(archiveProperties);
    }


  }
