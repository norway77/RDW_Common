package org.opentestsystem.rdw.utils;

import com.google.common.base.Function;
import org.assertj.core.api.Assertions;
import org.junit.Before;
import org.junit.Test;

import java.time.LocalDate;

import static java.time.Year.MAX_VALUE;
import static java.time.Year.MIN_VALUE;
import static org.assertj.core.api.Assertions.assertThat;

public class ParserHelperTest {

    private ParserHelper parserHelper;
    private DataElementErrorCollector errorCollector;

    @Before
    public void createParserHelper() {
        errorCollector = new DataElementErrorCollector();
        parserHelper = new ParserHelper(errorCollector);
    }

    @Test
    public void itShouldValidate() {
        Assertions.assertThat(parserHelper.validate("field", 23, (Function<Integer, Boolean>) value -> value > 0)).isTrue();
        assertThat(errorCollector.size()).isZero();

        Assertions.assertThat(parserHelper.validate("field", -7, (Function<Integer, Boolean>) value -> value > 0)).isFalse();
        assertThat(errorCollector.size()).isZero();

        Assertions.assertThat(parserHelper.validate("field", null, ParserHelper.toDouble)).isNull();
        assertThat(errorCollector.size()).isEqualTo(1);
        assertThat(errorCollector.contains(new DataElementError("field", null, "value may not be blank"))).isTrue();

        assertThat(parserHelper.validate("number", "test", Double::parseDouble)).isNull();
        assertThat(errorCollector.size()).isEqualTo(2);
        assertThat(errorCollector.contains(new DataElementError("number", "test", "For input string: \"test\""))).isTrue();
    }

    @Test
    public void itShouldParseToBoolean() {
        Assertions.assertThat(ParserHelper.toBoolean.apply("yes")).isEqualTo(true);
        Assertions.assertThat(ParserHelper.toBoolean.apply("YES")).isEqualTo(true);
        Assertions.assertThat(ParserHelper.toBoolean.apply("Yes")).isEqualTo(true);
        Assertions.assertThat(ParserHelper.toBoolean.apply("Y")).isEqualTo(true);
        Assertions.assertThat(ParserHelper.toBoolean.apply("y")).isEqualTo(true);
        Assertions.assertThat(ParserHelper.toBoolean.apply("TRUE")).isEqualTo(true);
        Assertions.assertThat(ParserHelper.toBoolean.apply("true")).isEqualTo(true);
        Assertions.assertThat(ParserHelper.toBoolean.apply("t")).isEqualTo(true);

        Assertions.assertThat(ParserHelper.toBoolean.apply("No")).isEqualTo(false);
        Assertions.assertThat(ParserHelper.toBoolean.apply("NO")).isEqualTo(false);
        Assertions.assertThat(ParserHelper.toBoolean.apply("no")).isEqualTo(false);
        Assertions.assertThat(ParserHelper.toBoolean.apply("n")).isEqualTo(false);
        Assertions.assertThat(ParserHelper.toBoolean.apply("N")).isEqualTo(false);
        Assertions.assertThat(ParserHelper.toBoolean.apply("FALSE")).isEqualTo(false);
        Assertions.assertThat(ParserHelper.toBoolean.apply("false")).isEqualTo(false);
        Assertions.assertThat(ParserHelper.toBoolean.apply("f")).isEqualTo(false);
    }

    @Test
    public void itShouldParseOptionalBoolean() {
        Assertions.assertThat(ParserHelper.toBooleanOrNull.apply("yes")).isEqualTo(true);
        Assertions.assertThat(ParserHelper.toBooleanOrNull.apply("no ")).isEqualTo(false);
        Assertions.assertThat(ParserHelper.toBooleanOrNull.apply("  ")).isNull();
    }

    @Test(expected = IllegalArgumentException.class)
    public void itShouldThrowUnsupportedValueForBoolean() {
        ParserHelper.toBoolean.apply("something");
    }

    @Test(expected = IllegalArgumentException.class)
    public void itShouldThrowUnsupportedForNull() {
        ParserHelper.toBoolean.apply(null);
    }

    @Test
    public void itShouldParseOptionalInteger() {
        Assertions.assertThat(ParserHelper.toIntegerOrNull.apply(null)).isNull();
        Assertions.assertThat(ParserHelper.toIntegerOrNull.apply(" ")).isNull();
        Assertions.assertThat(ParserHelper.toIntegerOrNull.apply("42")).isEqualTo(42);
        Assertions.assertThat(ParserHelper.toIntegerOrNull.apply("  42  ")).isEqualTo(42);
    }

    @Test(expected = IllegalArgumentException.class)
    public void itShouldFailToParseInvalidOptionalInteger() {
        ParserHelper.toIntegerOrNull.apply("notanumber");
    }

    @Test
    public void itShouldValidateString() {
        assertThat(parserHelper.validate("field", "test", 20, true)).isEqualTo("test");
        assertThat(errorCollector.isEmpty()).isTrue();

        assertThat(parserHelper.validate("field", "test       ", 5, false)).isEqualTo("test");
        assertThat(errorCollector.isEmpty()).isTrue();

        assertThat(parserHelper.validate("field", "    test", 5, false)).isEqualTo("test");
        assertThat(errorCollector.isEmpty()).isTrue();

        assertThat(parserHelper.validate("field", "test", 3, false)).isEqualTo("test");
        assertThat(errorCollector.contains(new DataElementError("field", "test", "string is too long, max length is " + 3))).isTrue();
    }

    @Test
    public void itShouldValidateEmptyString() {
        assertThat(parserHelper.validate("field", "", 20, false)).isNull();
        assertThat(errorCollector.isEmpty()).isTrue();

        assertThat(parserHelper.validate("field", "   ", 20, false)).isNull();
        assertThat(errorCollector.isEmpty()).isTrue();

        assertThat(parserHelper.validate("field", "   ", 20, true)).isNull();
        assertThat(errorCollector.contains(new DataElementError("field", "   ", "value may not be blank"))).isTrue();
    }

    @Test
    public void itShouldValidateNullString() {
        assertThat(parserHelper.validate("field", null, 20, false)).isNull();
        assertThat(errorCollector.isEmpty()).isTrue();

        assertThat(parserHelper.validate("field", null, 20, true)).isNull();
        assertThat(errorCollector.contains(new DataElementError("field", null, "value may not be blank"))).isTrue();
    }

    @Test
    public void itShouldParseYear() {
        Assertions.assertThat(ParserHelper.toYear.apply((long) MIN_VALUE)).isEqualTo(MIN_VALUE);
        Assertions.assertThat(ParserHelper.toYear.apply((long) MAX_VALUE)).isEqualTo(MAX_VALUE);
    }

    @Test(expected = IllegalArgumentException.class)
    public void itShouldFailToParseMinYear() {
        ParserHelper.toYear.apply((long) (MIN_VALUE - 1));
    }

    @Test(expected = IllegalArgumentException.class)
    public void itShouldFailToParseMaxYear() {
        ParserHelper.toYear.apply((long) (MAX_VALUE + 1));
    }

    @Test(expected = IllegalArgumentException.class)
    public void itShouldFailToParsNullYear() {
        ParserHelper.toYear.apply(null);
    }

    @Test(expected = IllegalArgumentException.class)
    public void itShouldFailOnBlankString() {
        ParserHelper.checkNotBlank.apply("   ");
    }

    @Test(expected = IllegalArgumentException.class)
    public void itShouldFailOnNullString() {
        ParserHelper.checkNotBlank.apply(null);
    }

    @Test
    public void itShouldCheckNotBlank() {
        Assertions.assertThat(ParserHelper.checkNotBlank.apply("test")).isEqualTo("test");
        Assertions.assertThat(ParserHelper.checkNotBlank.apply("  test  ")).isEqualTo("test");
    }

    @Test
    public void isShouldParseToDouble() {
        Assertions.assertThat(ParserHelper.toDouble.apply("20.22")).isEqualTo(20.22);
    }

    @Test(expected = IllegalArgumentException.class)
    public void isShouldFailToParseToDouble() {
        ParserHelper.toDouble.apply(" ");
    }

    @Test
    public void isShouldParseToInteger() {
        Assertions.assertThat(ParserHelper.toInteger.apply("20")).isEqualTo(20);
    }

    @Test(expected = IllegalArgumentException.class)
    public void isShouldFailToParseToInteger() {
        ParserHelper.toInteger.apply(" ");
    }

    @Test
    public void isShouldParseToLong() {
        Assertions.assertThat(ParserHelper.toLong.apply("20")).isEqualTo(20);
    }

    @Test(expected = IllegalArgumentException.class)
    public void isShouldFailToParseToLong() {
        ParserHelper.toLong.apply(" ");
    }

    @Test
    public void itShouldParseOptionalDate() {
        Assertions.assertThat(ParserHelper.toLocalDateOrNull.apply(null)).isNull();
        Assertions.assertThat(ParserHelper.toLocalDateOrNull.apply(" ")).isNull();
        Assertions.assertThat(ParserHelper.toLocalDateOrNull.apply("2007-12-03")).isEqualTo(LocalDate.parse("2007-12-03"));
        Assertions.assertThat(ParserHelper.toLocalDateOrNull.apply("  2007-12-03  ")).isEqualTo(LocalDate.parse("2007-12-03"));
    }

    @Test(expected = IllegalArgumentException.class)
    public void itShouldFailToParseInvalidLocalDateOrNull() {
        ParserHelper.toLocalDateOrNull.apply("notadate");
    }

    @Test
    public void isShouldParseToGrade() {
        Assertions.assertThat(ParserHelper.toGrade.apply("1")).isEqualTo("01");
        Assertions.assertThat(ParserHelper.toGrade.apply("2")).isEqualTo("02");
        Assertions.assertThat(ParserHelper.toGrade.apply("10")).isEqualTo("10");
        Assertions.assertThat(ParserHelper.toGrade.apply("101")).isEqualTo("101");
    }

    @Test(expected = IllegalArgumentException.class)
    public void isShouldFailToParseToGrade() {
        ParserHelper.toGrade.apply(" ");
    }

    @Test
    public void itShouldHaveAUsefulMessageForUnparseableDate() {
        // samples from the wild; yes, they are expected to fail but this tests the message back

        Assertions.assertThat(parserHelper.validate("testLocalDate", "8/1/17", ParserHelper.toLocalDate)).isNull();
        assertThat(errorCollector.size()).isEqualTo(1);
        assertThat(errorCollector.toJson()).isEqualTo("{\"messages\":[{\"elementName\":\"testLocalDate\",\"value\":\"8/1/17\",\"error\":\"invalid date [8/1/17], use format YYYY-MM-DD\"}]}");

        errorCollector.reset();
        Assertions.assertThat(parserHelper.validate("testLocalDateOrNull", "6/30/18", ParserHelper.toLocalDateOrNull)).isNull();
        assertThat(errorCollector.toJson()).isEqualTo("{\"messages\":[{\"elementName\":\"testLocalDateOrNull\",\"value\":\"6/30/18\",\"error\":\"invalid date [6/30/18], use format YYYY-MM-DD\"}]}");
    }
}
