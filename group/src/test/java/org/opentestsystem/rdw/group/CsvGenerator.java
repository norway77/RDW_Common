package org.opentestsystem.rdw.group;

import org.apache.commons.csv.CSVFormat;
import org.apache.commons.csv.CSVPrinter;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.net.URI;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import static com.google.common.collect.Lists.newArrayList;
import static org.opentestsystem.rdw.group.DefaultCsvValidationService.HeaderGroup;
import static org.opentestsystem.rdw.group.DefaultCsvValidationService.HeaderSSID;
import static org.opentestsystem.rdw.group.DefaultCsvValidationService.HeaderSchool;
import static org.opentestsystem.rdw.group.DefaultCsvValidationService.HeaderSubject;
import static org.opentestsystem.rdw.group.DefaultCsvValidationService.HeaderUser;
import static org.opentestsystem.rdw.group.DefaultCsvValidationService.HeaderYear;
import static org.opentestsystem.rdw.group.DefaultCsvValidationService.RequiredHeaders;

/**
 * This testing utility class can be used to generate arbitrarily-large CSV sample files.
 * Replace the school ids list with valid values from your local database.
 */
public class CsvGenerator {
    private static final Logger logger = LoggerFactory.getLogger(CsvGenerator.class);

    private static final int NumGroupsPerSchool = 1000; //4500
    private static final int NumStudentsPerGroup = 30;
    private static final String output = "file:///tmp/output.csv";
    private static final List<String> SchoolIds = newArrayList(
            "0cf31b8fe2f84a34bdc4331b35906e",
            "0e24e625687242a19891b7aab79be6",
            "10e502b720e84f23a87eb35a8926b8",
            "2c40f8bc1f1f4b34885fb7acc781f5",
            "3461a7012fe54bd3a197eb0d2c462f",
            "495316f47b524f728ab280491e7f42",
            "7354ce8f9adc41c4908a8a5d859c5e",
            "8f7097f6dc8f4067af4bb1260ef0b0",
            "961ac82c54164b06a56bad28eb76d6",
            "a7246df055a146f8b7aefe58d4c366",
            "ad99f307097347ef910cb217573d78",
            "aefa599e5edc4e8fb9c516224a8a37",
            "b6647223fd8742d7afadffe1eb768e",
            "b72fbea3769e41ca937208dd27f8d2",
            "bf783171a7a44f80b7be6f30721c91",
            "d8bb1a9ba9fc4ef0a076169babc051",
            "e8c7e6ab1bf240bd858353de330f33",
            "eb558506c9fe496b9bff7693ab676a",
            "ec793209fc7f4029a7e96d3beb20a1",
            "f7fc61a4c89b435fb18e8d705c8dab"
    );

    private static final String GroupPrefix = "Group_";

    public static void main(final String[] args) throws Exception {

        final URI uri = URI.create(output);
        final File file = new File(uri);
        if (!file.createNewFile()) {
            throw new IllegalStateException("Unable to create output file");
        }

        final CSVFormat format = CSVFormat.DEFAULT
                .withFirstRecordAsHeader()
                .withSkipHeaderRecord(false)
                .withHeader(RequiredHeaders.toArray(new String[0]));
        final Map<String, String> recordValues = new HashMap<>();
        recordValues.put(HeaderYear, "2017");

        try (final CSVPrinter printer = new CSVPrinter(new FileWriter(file), format)) {

            for (final String schoolId : SchoolIds) {
                logger.info("Starting school: {}", schoolId);
                recordValues.put(HeaderSchool, schoolId);

                int groupCount = NumGroupsPerSchool;
                while (groupCount >= 0) {
                    final String groupId = GroupPrefix + groupCount--;
                    recordValues.put(HeaderGroup, groupId);

                    //add subject row
                    recordValues.put(HeaderSubject, "ELA");
                    printRow(printer, recordValues);
                    recordValues.remove(HeaderSubject);

                    //add teacher row
                    recordValues.put(HeaderUser, "teacher@somewhere.com");
                    printRow(printer, recordValues);
                    recordValues.remove(HeaderUser);

                    //add students
                    int studentCount = NumStudentsPerGroup;
                    while (studentCount >= 0) {
                        recordValues.put(HeaderSSID, schoolId + groupId + "_" + studentCount--);
                        printRow(printer, recordValues);
                    }
                    recordValues.remove(HeaderSSID);
                }
            }
        }
    }

    private static void printRow(final CSVPrinter printer, final Map<String, String> row) throws IOException {
        final List<String> values = new ArrayList<>(RequiredHeaders.size());
        for (final String header : RequiredHeaders) {
            values.add(row.get(header));
        }
        printer.printRecord(values);
    }

}
